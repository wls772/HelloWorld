# 服务器地址配置说明

在扣子平台添加插件时，需要填写服务器地址。根据你的部署方式，有以下几种情况：

## 方式一：本地测试（使用内网穿透）

如果你在本地运行服务，需要使用内网穿透工具将本地服务暴露到公网。

### 1. 使用 ngrok（推荐）

1. **下载 ngrok**
   - 访问 https://ngrok.com/download
   - 下载并解压

2. **启动本地服务**
   ```bash
   python sina_news_plugin.py
   ```

3. **启动 ngrok**
   ```bash
   ngrok http 8000
   ```

4. **获取公网地址**
   - ngrok 会显示类似这样的地址：`https://abc123.ngrok.io`
   - **在 openapi.yaml 中填写**：`https://abc123.ngrok.io`
   - **在扣子平台填写**：`https://abc123.ngrok.io`

### 2. 使用其他内网穿透工具

- **frp**：https://github.com/fatedier/frp
- **localtunnel**：`npx localtunnel --port 8000`
- **serveo**：`ssh -R 80:localhost:8000 serveo.net`

## 方式二：部署到云服务器

### 1. 使用云服务器（阿里云、腾讯云、AWS等）

1. **购买云服务器**，获得公网IP或域名

2. **部署服务**
   ```bash
   # 在服务器上安装依赖
   pip install -r requirements.txt
   
   # 使用 screen 或 tmux 后台运行
   screen -S sina_news
   python sina_news_plugin.py
   # 按 Ctrl+A 然后按 D 退出screen
   ```

3. **配置防火墙**
   - 确保服务器开放 8000 端口（或你使用的端口）

4. **填写服务器地址**
   - 如果有域名：`https://your-domain.com`
   - 如果只有IP：`http://your-ip:8000`（注意：扣子平台可能要求HTTPS）

### 2. 使用免费部署平台

#### Railway（推荐，免费额度）

1. 访问 https://railway.app
2. 使用 GitHub 登录
3. 创建新项目，连接你的代码仓库
4. 设置启动命令：`python sina_news_plugin.py`
5. 部署后获得域名，例如：`https://your-app.railway.app`
6. **填写服务器地址**：`https://your-app.railway.app`

#### Render

1. 访问 https://render.com
2. 创建 Web Service
3. 连接代码仓库
4. 设置启动命令：`python sina_news_plugin.py`
5. 部署后获得域名
6. **填写服务器地址**：`https://your-app.onrender.com`

#### Vercel（需要配置）

1. 创建 `vercel.json` 配置文件
2. 部署到 Vercel
3. 获得域名
4. **填写服务器地址**：`https://your-app.vercel.app`

## 方式三：使用 Docker 部署

### 1. 创建 Dockerfile

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY sina_news_plugin.py .

EXPOSE 8000

CMD ["python", "sina_news_plugin.py"]
```

### 2. 构建和运行

```bash
docker build -t sina-news-plugin .
docker run -d -p 8000:8000 --name sina-news sina-news-plugin
```

### 3. 部署到 Docker 平台

- **Docker Hub** + 云服务器
- **Fly.io**：`flyctl launch`
- **Railway**：支持 Docker 部署

## 在扣子平台配置

### 步骤：

1. **登录扣子平台**
   - 访问 https://www.coze.cn

2. **进入插件管理**
   - 点击"插件" -> "创建插件"

3. **选择插件类型**
   - 选择"OpenAPI插件"

4. **填写插件信息**
   - **插件名称**：新浪财经新闻
   - **插件描述**：爬取新浪财经新闻
   - **API地址**：填写你的服务器地址（例如：`https://abc123.ngrok.io`）
   - **OpenAPI文档**：可以上传 `openapi.yaml` 文件，或者填写 `https://your-server/openapi.json`

5. **测试插件**
   - 在扣子平台测试插件是否正常工作

## 重要提示

### ⚠️ HTTPS 要求

- 扣子平台**可能要求使用 HTTPS**
- 如果只有 HTTP，考虑：
  - 使用 ngrok（自动提供 HTTPS）
  - 使用 Nginx 反向代理配置 SSL
  - 使用云平台的 HTTPS 功能

### 🔒 安全建议

1. **添加认证**（可选）
   - 在 FastAPI 中添加 API Key 验证
   - 防止未授权访问

2. **限制访问频率**
   - 添加请求频率限制
   - 防止滥用

3. **日志记录**
   - 记录 API 调用日志
   - 便于排查问题

## 快速测试

部署后，测试服务器是否可访问：

```bash
# 测试根路径
curl https://your-server.com/

# 测试健康检查
curl https://your-server.com/health

# 测试新闻查询
curl "https://your-server.com/news?symbol=sh600000&limit=2"
```

## 常见问题

### Q: 扣子平台提示"无法连接服务器"
A: 
- 检查服务器是否正常运行
- 检查防火墙是否开放端口
- 检查服务器地址是否正确（不要带路径，只填域名/IP）
- 确保使用 HTTPS（如果平台要求）

### Q: 本地测试如何让扣子平台访问？
A: 使用 ngrok 等内网穿透工具，将本地服务暴露到公网。

### Q: 服务器地址需要带端口吗？
A: 
- 如果使用标准端口（80/443），不需要
- 如果使用其他端口（如8000），需要带上端口号
- 但扣子平台可能要求使用标准端口，建议使用反向代理

### Q: 如何让服务一直运行？
A: 
- 使用 `screen` 或 `tmux`
- 使用 `systemd` 服务
- 使用 Docker
- 使用云平台的自动重启功能

